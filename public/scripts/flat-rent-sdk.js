export const database = [
    {
        id: 'vnd331',
        title: 'Radisson Royal Hotel',
        details: 'Отель расположен в 4 минутах ходьбы от станции метро «Маяковская». К услугам гостей фитнес-центр и спа-центр с сауной и гидромассажной ванной.',
        photos: ['vnd331.png', 'vnd331.png'],
        coordinates: [59.9322936, 30.3460129],
        bookedDates: [],
        price: 12000,
        remoteness: 6.7
    },
    {
        id: 'ab2e2',
        title: 'Номера на Садовой',
        details: 'Расположен в 7 минутах ходьбы от Невского проспекта. К услугам гостей круглосуточная стойка регистрации и бесплатный Wi-Fi.',
        photos: ['ab2e2.png', 'ab2e2.png'],
        coordinates: [59.930325, 30.3291592],
        bookedDates: [],
        price: 4500,
        remoteness: 16.2
    },
    {
        id: 'mvm32l',
        title: 'Мини Отель на Невском 136',
        details: 'Мини-отель расположен в Санкт-Петербурге, в 5 минутах ходьбы от станции метро «Площадь Восстания» и Московского железнодорожного вокзала.',
        photos: ['mvm32l.png', 'mvm32l.png'],
        coordinates: [59.9299603, 30.3658932],
        bookedDates: [],
        price: 3800,
        remoteness: 1.3
    },
    {
        id: 'bvep12',
        title: 'Отель Усадьба Державина',
        details: 'Прекрасный отель недалеко от Исаакиевского собора с бесплатным Wi-Fi на всей территории.',
        photos: ['bvep12.png', 'bvep12.png'],
        coordinates: [59.9194966, 30.309389],
        bookedDates: [],
        price: 8700,
        remoteness: 10.0
    }
];
export function cloneDate(date) {
    return new Date(date.getTime());
}
export function addDays(date, days) {
    date.setDate(date.getDate() + days);
    return date;
}
export const backendPort = 3040;
export const localStorageKey = 'flat-rent-db';
export class FlatRentSdk {
    constructor() {
        this._generateTransactionId = () => {
            const min = 1000;
            const max = 9999;
            const num = Math.random() * (max - min) + min;
            return Math.floor(num);
        };
        if (this._readDatabase() == null) {
            this._writeDatabase(database);
        }
        this.database = this._readDatabase();
    }
    /**
     * Get flat by ID.
     *
     * @param {string} id Flat ID.
     * @returns {Promise<Object|null>} Flat.
     */
    get(id) {
        const flat = this.database.find((item) => {
            return item.id === id;
        });
        return Promise.resolve(flat == null ? flat : this._formatFlatObject(flat));
    }
    /**
     * Search for flats.
     *
     * @param {Object} parameters Search parameters
     * @param {string}parameters.city City name
     * @param {Date} parameters.checkInDate Check-in date
     * @param {Date} parameters.checkOutDate Check-out date
     * @param {number} [parameters.priceLimit] Max price for a night
     * @returns {Object[]} List of suitable flats.
     */
    search(parameters) {
        return new Promise((resolve, reject) => {
            try {
                if (parameters.city != 'Санкт-Петербург') {
                    throw new Error(`Passed unsupported city - "${parameters.city}".`);
                }
                if (!(parameters.checkInDate instanceof Date) || !(parameters.checkOutDate instanceof Date)) {
                    throw new Error(`Passed invalid check-in or check-out date - from "${parameters.checkInDate}" to "${parameters.checkOutDate}".`);
                }
                this._assertDatesAreCorrect(parameters.checkInDate, parameters.checkOutDate);
                if (parameters.priceLimit != null && (isNaN(parameters.priceLimit) || !isFinite(parameters.priceLimit))) {
                    throw new Error(`Passed invalid price limit - "${parameters.priceLimit}".`);
                }
                let flats = this.database;
                if (parameters.priceLimit != null) {
                    flats = flats.filter((flat) => {
                        return flat.price <= parameters.priceLimit;
                    });
                }
                const dateRange = this._generateDateRange(parameters.checkInDate, parameters.checkOutDate);
                flats = flats.filter((flat) => {
                    return this._areAllDatesAvailable(flat, dateRange);
                });
                flats = flats.map((flat) => {
                    return this._formatFlatObject(flat, dateRange.length - 1);
                });
                resolve(flats);
            }
            catch (error) {
                reject(error);
            }
        });
    }
    /**
     * Book flat.
     *
     * @param {number} flatId
     * @param {Date} checkInDate
     * @param {Date} checkOutDate
     * @returns {number}
     */
    book(flatId, checkInDate, checkOutDate) {
        return new Promise((resolve, reject) => {
            try {
                const flat = this.database.find((item) => {
                    return item.id === flatId;
                });
                if (flat == null) {
                    throw new Error('There is no flat with ID "' + flatId + '".');
                }
                this._assertDatesAreCorrect(checkInDate, checkOutDate);
                const datesToBook = this._generateDateRange(checkInDate, checkOutDate);
                if (!this._areAllDatesAvailable(flat, datesToBook)) {
                    throw new Error(`Flat ${flat.id} is not available for dates ${datesToBook.join(",")}.`);
                }
                const bookedDates = datesToBook.map((date) => {
                    return date.getTime();
                });
                flat.bookedDates.push(...bookedDates);
                for (let i = 0; i < this.database.length; i++) {
                    if (this.database[i].id === flat.id) {
                        this.database[i] = flat;
                        break;
                    }
                }
                this._writeDatabase(this.database);
                resolve(this._generateTransactionId());
            }
            catch (error) {
                reject(error);
            }
        });
    }
    _assertDatesAreCorrect(checkInDate, checkOutDate) {
        const today = new Date();
        this._resetTime(today);
        this._resetTime(checkInDate);
        this._resetTime(checkOutDate);
        const diffToday = this._calculateDifferenceInDays(today, checkInDate);
        if (diffToday < 0) {
            throw new Error('Check-in date can\'t be in the past.');
        }
        const diffCheck = this._calculateDifferenceInDays(checkInDate, checkOutDate);
        if (diffCheck < 0) {
            throw new Error('Check-out date must be grater then check-in date.');
        }
    }
    _resetTime(date) {
        date.setHours(0);
        date.setMinutes(0);
        date.setSeconds(0);
        date.setMilliseconds(0);
    }
    _calculateDifferenceInDays(startDate, endDate) {
        const difference = endDate.getTime() - startDate.getTime();
        return Math.floor(difference / (1000 * 60 * 60 * 24));
    }
    _generateDateRange(from, to) {
        const dates = [];
        const differenceInDays = this._calculateDifferenceInDays(from, to);
        dates.push(new Date(from.getFullYear(), from.getMonth(), from.getDate()));
        for (let i = 1; i <= differenceInDays; i++) {
            dates.push(new Date(from.getFullYear(), from.getMonth(), from.getDate() + i));
        }
        return dates;
    }
    _areAllDatesAvailable(flat, dateRange) {
        return dateRange.every((date) => {
            return !flat.bookedDates.includes(date.getTime());
        });
    }
    _formatFlatObject(flat, nightNumber) {
        const formattedFlat = Object.assign({}, flat);
        formattedFlat.photos = formattedFlat.photos.map((photoUrl) => {
            return `http://localhost:${backendPort}/img/${photoUrl}`;
        });
        if (nightNumber != null) {
            formattedFlat.totalPrice = nightNumber * formattedFlat.price;
            delete formattedFlat.price;
        }
        return formattedFlat;
    }
    _readDatabase() {
        const data = window.localStorage.getItem(localStorageKey);
        if (data == null) {
            return data;
        }
        return JSON.parse(data);
    }
    _writeDatabase(database) {
        window.localStorage.setItem(localStorageKey, JSON.stringify(database));
    }
    _syncDatabase(database) {
        this._writeDatabase(database);
        this.database = this._readDatabase();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmxhdC1yZW50LXNkay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9mbGF0LXJlbnQtc2RrLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE1BQU0sQ0FBQyxNQUFNLFFBQVEsR0FBRztJQUNwQjtRQUNJLEVBQUUsRUFBRSxRQUFRO1FBQ1osS0FBSyxFQUFFLHNCQUFzQjtRQUM3QixPQUFPLEVBQUUsZ0pBQWdKO1FBQ3pKLE1BQU0sRUFBRSxDQUFDLFlBQVksRUFBRSxZQUFZLENBQUM7UUFDcEMsV0FBVyxFQUFFLENBQUMsVUFBVSxFQUFDLFVBQVUsQ0FBQztRQUNwQyxXQUFXLEVBQUUsRUFBRTtRQUNmLEtBQUssRUFBRSxLQUFLO1FBQ1osVUFBVSxFQUFFLEdBQUc7S0FDbEI7SUFDRDtRQUNJLEVBQUUsRUFBRSxPQUFPO1FBQ1gsS0FBSyxFQUFFLG1CQUFtQjtRQUMxQixPQUFPLEVBQUUsNkhBQTZIO1FBQ3RJLE1BQU0sRUFBRSxDQUFDLFdBQVcsRUFBRSxXQUFXLENBQUM7UUFDbEMsV0FBVyxFQUFFLENBQUMsU0FBUyxFQUFDLFVBQVUsQ0FBQztRQUNuQyxXQUFXLEVBQUUsRUFBRTtRQUNmLEtBQUssRUFBRSxJQUFJO1FBQ1gsVUFBVSxFQUFFLElBQUk7S0FDbkI7SUFDRDtRQUNJLEVBQUUsRUFBRSxRQUFRO1FBQ1osS0FBSyxFQUFFLDJCQUEyQjtRQUNsQyxPQUFPLEVBQUUsMklBQTJJO1FBQ3BKLE1BQU0sRUFBRSxDQUFDLFlBQVksRUFBRSxZQUFZLENBQUM7UUFDcEMsV0FBVyxFQUFFLENBQUMsVUFBVSxFQUFDLFVBQVUsQ0FBQztRQUNwQyxXQUFXLEVBQUUsRUFBRTtRQUNmLEtBQUssRUFBRSxJQUFJO1FBQ1gsVUFBVSxFQUFFLEdBQUc7S0FDbEI7SUFDRDtRQUNJLEVBQUUsRUFBRSxRQUFRO1FBQ1osS0FBSyxFQUFFLHlCQUF5QjtRQUNoQyxPQUFPLEVBQUUsMEZBQTBGO1FBQ25HLE1BQU0sRUFBRSxDQUFDLFlB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YWJhc2UgPSBbXG4gICAge1xuICAgICAgICBpZDogJ3ZuZDMzMScsXG4gICAgICAgIHRpdGxlOiAnUmFkaXNzb24gUm95YWwgSG90ZWwnLFxuICAgICAgICBkZXRhaWxzOiAn0J7RgtC10LvRjCDRgNCw0YHQv9C+0LvQvtC20LXQvSDQsiA0INC80LjQvdGD0YLQsNGFINGF0L7QtNGM0LHRiyDQvtGCINGB0YLQsNC90YbQuNC4INC80LXRgtGA0L4gwqvQnNCw0Y/QutC+0LLRgdC60LDRj8K7LiDQmiDRg9GB0LvRg9Cz0LDQvCDQs9C+0YHRgtC10Lkg0YTQuNGC0L3QtdGBLdGG0LXQvdGC0YAg0Lgg0YHQv9CwLdGG0LXQvdGC0YAg0YEg0YHQsNGD0L3QvtC5INC4INCz0LjQtNGA0L7QvNCw0YHRgdCw0LbQvdC+0Lkg0LLQsNC90L3QvtC5LicsXG4gICAgICAgIHBob3RvczogWyd2bmQzMzEucG5nJywgJ3ZuZDMzMS5wbmcnXSxcbiAgICAgICAgY29vcmRpbmF0ZXM6IFs1OS45MzIyOTM2LDMwLjM0NjAxMjldLFxuICAgICAgICBib29rZWREYXRlczogW10sXG4gICAgICAgIHByaWNlOiAxMjAwMCxcbiAgICAgICAgcmVtb3RlbmVzczogNi43XG4gICAgfSxcbiAgICB7XG4gICAgICAgIGlkOiAnYWIyZTInLFxuICAgICAgICB0aXRsZTogJ9Cd0L7QvNC10YDQsCDQvdCwINCh0LDQtNC+0LLQvtC5JyxcbiAgICAgICAgZGV0YWlsczogJ9Cg0LDRgdC/0L7Qu9C+0LbQtdC9INCyIDcg0LzQuNC90YPRgtCw0YUg0YXQvtC00YzQsdGLINC+0YIg0J3QtdCy0YHQutC+0LPQviDQv9GA0L7RgdC/0LXQutGC0LAuINCaINGD0YHQu9GD0LPQsNC8INCz0L7RgdGC0LXQuSDQutGA0YPQs9C70L7RgdGD0YLQvtGH0L3QsNGPINGB0YLQvtC50LrQsCDRgNC10LPQuNGB0YLRgNCw0YbQuNC4INC4INCx0LXRgdC/0LvQsNGC0L3Ri9C5IFdpLUZpLicsXG4gICAgICAgIHBob3RvczogWydhYjJlMi5wbmcnLCAnYWIyZTIucG5nJ10sXG4gICAgICAgIGNvb3JkaW5hdGVzOiBbNTkuOTMwMzI1LDMwLjMyOTE1OTJdLFxuICAgICAgICBib29rZWREYXRlczogW10sXG4gICAgICAgIHByaWNlOiA0NTAwLFxuICAgICAgICByZW1vdGVuZXNzOiAxNi4yXG4gICAgfSxcbiAgICB7XG4gICAgICAgIGlkOiAnbXZtMzJsJyxcbiAgICAgICAgdGl0bGU6ICfQnNC40L3QuCDQntGC0LXQu9GMINC90LAg0J3QtdCy0YHQutC+0LwgMTM2JyxcbiAgICAgICAgZGV0YWlsczogJ9Cc0LjQvdC4LdC+0YLQtdC70Ywg0YDQsNGB0L/QvtC70L7QttC10L0g0LIg0KHQsNC90LrRgi3Qn9C10YLQtdGA0LHRg9GA0LPQtSwg0LIgNSDQvNC40L3Rg9GC0LDRhSDRhdC+0LTRjNCx0Ysg0L7RgiDRgdGC0LDQvdGG0LjQuCDQvNC10YLRgNC+IMKr0J/Qu9C+0YnQsNC00Ywg0JLQvtGB0YHRgtCw0L3QuNGPwrsg0Lgg0JzQvtGB0LrQvtCy0YHQutC+0LPQviDQttC10LvQtdC30L3QvtC00L7RgNC+0LbQvdC+0LPQviDQstC+0LrQt9Cw0LvQsC4nLFxuICAgICAgICBwaG90b3M6IFsnbXZtMzJsLnBuZycsICdtdm0zMmwucG5nJ10sXG4gICAgICAgIGNvb3JkaW5hdGVzOiBbNTkuOTI5OTYwMywzMC4zNjU4OTMyXSxcbiAgICAgICAgYm9va2VkRGF0ZXM6IFtdLFxuICAgICAgICBwcmljZTogMzgwMCxcbiAgICAgICAgcmVtb3RlbmVzczogMS4zXG4gICAgfSxcbiAgICB7XG4gICAgICAgIGlkOiAnYnZlcDEyJyxcbiAgICAgICAgdGl0bGU6ICfQntGC0LXQu9GMINCj0YHQsNC00YzQsdCwINCU0LXRgNC20LDQstC40L3QsCcsXG4gICAgICAgIGRldGFpbHM6ICfQn9GA0LXQutGA0LDRgdC90YvQuSDQvtGC0LXQu9GMINC90LXQtNCw0LvQtdC60L4g0L7RgiDQmNGB0LDQsNC60LjQtdCy0YHQutC+0LPQviDRgdC+0LHQvtGA0LAg0YEg0LHQtdGB0L/Qu9Cw0YLQvdGL0LwgV2ktRmkg0L3QsCDQstGB0LXQuSDRgtC10YDRgNC40YLQvtGA0LjQuC4nLFxuICAgICAgICBwaG90b3M6IFsnYnZlcDEyLnBuZycsICdidmVwMTIucG5nJ10sXG4gICAgICAgIGNvb3JkaW5hdGVzOiBbNTkuOTE5NDk2NiwzMC4zMDkzODldLFxuICAgICAgICBib29rZWREYXRlczogW10sXG4gICAgICAgIHByaWNlOiA4NzAwLFxuICAgICAgICByZW1vdGVuZXNzOiAxMC4wXG4gICAgfVxuXVxuXG5leHBvcnQgZnVuY3Rpb24gY2xvbmVEYXRlKGRhdGUpIHtcbiAgICByZXR1cm4gbmV3IERhdGUoZGF0ZS5nZXRUaW1lKCkpXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBhZGREYXlzKGRhdGUsIGRheXMpIHtcbiAgICBkYXRlLnNldERhdGUoZGF0ZS5nZXREYXRlKCkgKyBkYXlzKVxuICAgIHJldHVybiBkYXRlXG59XG5cbmV4cG9ydCBjb25zdCBiYWNrZW5kUG9ydCA9IDMwNDBcbmV4cG9ydCBjb25zdCBsb2NhbFN0b3JhZ2VLZXkgPSAnZmxhdC1yZW50LWRiJ1xuXG5leHBvcnQgY2xhc3MgRmxhdFJlbnRTZGsge1xuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICBpZiAodGhpcy5fcmVhZERhdGFiYXNlKCkgPT0gbnVsbCkge1xuICAgICAgICAgICAgdGhpcy5fd3JpdGVEYXRhYmFzZShkYXRhYmFzZSlcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuZGF0YWJhc2UgPSB0aGlzLl9yZWFkRGF0YWJhc2UoKVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCBmbGF0IGJ5IElELlxuICAgICAqIFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBpZCBGbGF0IElELlxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlPE9iamVjdHxudWxsPn0gRmxhdC5cbiAgICAgKi9cbiAgICBnZXQoaWQpIHtcbiAgICAgICAgY29uc3QgZmxhdCA9IHRoaXMuZGF0YWJhc2UuZmluZCgoaXRlbSkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIGl0ZW0uaWQgPT09IGlkXG4gICAgICAgIH0pXG5cbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShmbGF0ID09IG51bGwgPyBmbGF0IDogdGhpcy5fZm9ybWF0RmxhdE9iamVjdChmbGF0KSlcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTZWFyY2ggZm9yIGZsYXRzLlxuICAgICAqIFxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSBwYXJhbWV0ZXJzIFNlYXJjaCBwYXJhbWV0ZXJzXG4gICAgICogQHBhcmFtIHtzdHJpbmd9cGFyYW1ldGVycy5jaXR5IENpdHkgbmFtZVxuICAgICAqIEBwYXJhbSB7RGF0ZX0gcGFyYW1ldGVycy5jaGVja0luRGF0ZSBDaGVjay1pbiBkYXRlXG4gICAgICogQHBhcmFtIHtEYXRlfSBwYXJhbWV0ZXJzLmNoZWNrT3V0RGF0ZSBDaGVjay1vdXQgZGF0ZVxuICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbcGFyYW1ldGVycy5wcmljZUxpbWl0XSBNYXggcHJpY2UgZm9yIGEgbmlnaHRcbiAgICAgKiBAcmV0dXJucyB7T2JqZWN0W119IExpc3Qgb2Ygc3VpdGFibGUgZmxhdHMuXG4gICAgICovXG4gICAgc2VhcmNoKHBhcmFtZXRlcnMpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgaWYgKHBhcmFtZXRlcnMuY2l0eSAhPSAn0KHQsNC90LrRgi3Qn9C10YLQtdGA0LHRg9GA0LMnKSB7XG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgUGFzc2VkIHVuc3VwcG9ydGVkIGNpdHkgLSBcIiR7cGFyYW1ldGVycy5jaXR5fVwiLmApXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKCEocGFyYW1ldGVycy5jaGVja0luRGF0ZSBpbnN0YW5jZW9mIERhdGUpIHx8ICEocGFyYW1ldGVycy5jaGVja091dERhdGUgaW5zdGFuY2VvZiBEYXRlKSkge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFBhc3NlZCBpbnZhbGlkIGNoZWNrLWluIG9yIGNoZWNrLW91dCBkYXRlIC0gZnJvbSBcIiR7cGFyYW1ldGVycy5jaGVja0luRGF0ZX1cIiB0byBcIiR7cGFyYW1ldGVycy5jaGVja091dERhdGV9XCIuYClcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGhpcy5fYXNzZXJ0RGF0ZXNBcmVDb3JyZWN0KHBhcmFtZXRlcnMuY2hlY2tJbkRhdGUsIHBhcmFtZXRlcnMuY2hlY2tPdXREYXRlKVxuXG4gICAgICAgICAgICAgICAgaWYgKHBhcmFtZXRlcnMucHJpY2VMaW1pdCAhPSBudWxsICYmIChpc05hTihwYXJhbWV0ZXJzLnByaWNlTGltaXQpIHx8ICFpc0Zpbml0ZShwYXJhbWV0ZXJzLnByaWNlTGltaXQpKSkge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFBhc3NlZCBpbnZhbGlkIHByaWNlIGxpbWl0IC0gXCIke3BhcmFtZXRlcnMucHJpY2VMaW1pdH1cIi5gKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgbGV0IGZsYXRzID0gdGhpcy5kYXRhYmFzZVxuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAocGFyYW1ldGVycy5wcmljZUxpbWl0ICE9IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgZmxhdHMgPSBmbGF0cy5maWx0ZXIoKGZsYXQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmbGF0LnByaWNlIDw9IHBhcmFtZXRlcnMucHJpY2VMaW1pdFxuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgY29uc3QgZGF0ZVJhbmdlID0gdGhpcy5fZ2VuZXJhdGVEYXRlUmFuZ2UocGFyYW1ldGVycy5jaGVja0luRGF0ZSwgcGFyYW1ldGVycy5jaGVja091dERhdGUpXG4gICAgICAgICAgICAgICAgZmxhdHMgPSBmbGF0cy5maWx0ZXIoKGZsYXQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2FyZUFsbERhdGVzQXZhaWxhYmxlKGZsYXQsIGRhdGVSYW5nZSlcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICBcbiAgICAgICAgICAgICAgICBmbGF0cyA9IGZsYXRzLm1hcCgoZmxhdCkgPT4ge1xuICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9mb3JtYXRGbGF0T2JqZWN0KGZsYXQsIGRhdGVSYW5nZS5sZW5ndGggLSAxKVxuICAgICAgICAgICAgICAgIH0pXG5cbiAgICAgICAgICAgICAgICByZXNvbHZlKGZsYXRzKVxuICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQm9vayBmbGF0LlxuICAgICAqIFxuICAgICAqIEBwYXJhbSB7bnVtYmVyfSBmbGF0SWQgXG4gICAgICogQHBhcmFtIHtEYXRlfSBjaGVja0luRGF0ZSBcbiAgICAgKiBAcGFyYW0ge0RhdGV9IGNoZWNrT3V0RGF0ZVxuICAgICAqIEByZXR1cm5zIHtudW1iZXJ9XG4gICAgICovXG4gICAgYm9vayhmbGF0SWQsIGNoZWNrSW5EYXRlLCBjaGVja091dERhdGUpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgY29uc3QgZmxhdCA9IHRoaXMuZGF0YWJhc2UuZmluZCgoaXRlbSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXRlbS5pZCA9PT0gZmxhdElkXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKGZsYXQgPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RoZXJlIGlzIG5vIGZsYXQgd2l0aCBJRCBcIicgKyBmbGF0SWQgKyAnXCIuJylcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGhpcy5fYXNzZXJ0RGF0ZXNBcmVDb3JyZWN0KGNoZWNrSW5EYXRlLCBjaGVja091dERhdGUpXG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGNvbnN0IGRhdGVzVG9Cb29rID0gdGhpcy5fZ2VuZXJhdGVEYXRlUmFuZ2UoY2hlY2tJbkRhdGUsIGNoZWNrT3V0RGF0ZSlcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX2FyZUFsbERhdGVzQXZhaWxhYmxlKGZsYXQsIGRhdGVzVG9Cb29rKSkge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZsYXQgJHtmbGF0LmlkfSBpcyBub3QgYXZhaWxhYmxlIGZvciBkYXRlcyAke2RhdGVzVG9Cb29rLmpvaW4oXCIsXCIpfS5gKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgY29uc3QgYm9va2VkRGF0ZXMgPSBkYXRlc1RvQm9vay5tYXAoKGRhdGUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRhdGUuZ2V0VGltZSgpXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICBmbGF0LmJvb2tlZERhdGVzLnB1c2goLi4uYm9va2VkRGF0ZXMpXG4gICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmRhdGFiYXNlLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmRhdGFiYXNlW2ldLmlkID09PSBmbGF0LmlkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRhdGFiYXNlW2ldID0gZmxhdFxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aGlzLl93cml0ZURhdGFiYXNlKHRoaXMuZGF0YWJhc2UpXG4gICAgICAgIFxuICAgICAgICAgICAgICAgIHJlc29sdmUodGhpcy5fZ2VuZXJhdGVUcmFuc2FjdGlvbklkKCkpXG4gICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcilcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICB9XG5cbiAgICBfYXNzZXJ0RGF0ZXNBcmVDb3JyZWN0KGNoZWNrSW5EYXRlLCBjaGVja091dERhdGUpIHtcbiAgICAgICAgY29uc3QgdG9kYXkgPSBuZXcgRGF0ZSgpXG4gICAgICAgIHRoaXMuX3Jlc2V0VGltZSh0b2RheSlcbiAgICAgICAgdGhpcy5fcmVzZXRUaW1lKGNoZWNrSW5EYXRlKVxuICAgICAgICB0aGlzLl9yZXNldFRpbWUoY2hlY2tPdXREYXRlKVxuXG4gICAgICAgIGNvbnN0IGRpZmZUb2RheSA9IHRoaXMuX2NhbGN1bGF0ZURpZmZlcmVuY2VJbkRheXModG9kYXksIGNoZWNrSW5EYXRlKVxuICAgICAgICBpZiAoZGlmZlRvZGF5IDwgMCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDaGVjay1pbiBkYXRlIGNhblxcJ3QgYmUgaW4gdGhlIHBhc3QuJylcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGRpZmZDaGVjayA9IHRoaXMuX2NhbGN1bGF0ZURpZmZlcmVuY2VJbkRheXMoY2hlY2tJbkRhdGUsIGNoZWNrT3V0RGF0ZSlcbiAgICAgICAgaWYgKGRpZmZDaGVjayA8IDApIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ2hlY2stb3V0IGRhdGUgbXVzdCBiZSBncmF0ZXIgdGhlbiBjaGVjay1pbiBkYXRlLicpXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBfcmVzZXRUaW1lKGRhdGUpIHtcbiAgICAgICAgZGF0ZS5zZXRIb3VycygwKVxuICAgICAgICBkYXRlLnNldE1pbnV0ZXMoMClcbiAgICAgICAgZGF0ZS5zZXRTZWNvbmRzKDApXG4gICAgICAgIGRhdGUuc2V0TWlsbGlzZWNvbmRzKDApXG4gICAgfVxuXG4gICAgX2NhbGN1bGF0ZURpZmZlcmVuY2VJbkRheXMoc3RhcnREYXRlLCBlbmREYXRlKSB7XG4gICAgICAgIGNvbnN0IGRpZmZlcmVuY2UgPSBlbmREYXRlLmdldFRpbWUoKSAtIHN0YXJ0RGF0ZS5nZXRUaW1lKClcblxuICAgICAgICByZXR1cm4gTWF0aC5mbG9vcihkaWZmZXJlbmNlIC8gKDEwMDAgKiA2MCAqIDYwICogMjQpKVxuICAgIH1cblxuICAgIF9nZW5lcmF0ZURhdGVSYW5nZShmcm9tLCB0bykge1xuICAgICAgICBjb25zdCBkYXRlcyA9IFtdXG4gICAgICAgIGNvbnN0IGRpZmZlcmVuY2VJbkRheXMgPSB0aGlzLl9jYWxjdWxhdGVEaWZmZXJlbmNlSW5EYXlzKGZyb20sIHRvKVxuICAgICAgICBcbiAgICAgICAgZGF0ZXMucHVzaChuZXcgRGF0ZShmcm9tLmdldEZ1bGxZZWFyKCksIGZyb20uZ2V0TW9udGgoKSwgZnJvbS5nZXREYXRlKCkpKVxuICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8PSBkaWZmZXJlbmNlSW5EYXlzOyBpKyspIHtcbiAgICAgICAgICBkYXRlcy5wdXNoKG5ldyBEYXRlKGZyb20uZ2V0RnVsbFllYXIoKSwgZnJvbS5nZXRNb250aCgpLCBmcm9tLmdldERhdGUoKSArIGkpKVxuICAgICAgICB9XG4gICAgXG4gICAgICAgIHJldHVybiBkYXRlc1xuICAgIH1cblxuICAgIF9nZW5lcmF0ZVRyYW5zYWN0aW9uSWQgPSAoKSA9PiB7XG4gICAgICAgIGNvbnN0IG1pbiA9IDEwMDBcbiAgICAgICAgY29uc3QgbWF4ID0gOTk5OVxuICAgICAgICBjb25zdCBudW0gPSBNYXRoLnJhbmRvbSgpICogKG1heCAtIG1pbikgKyBtaW5cbiAgICBcbiAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IobnVtKVxuICAgIH1cblxuICAgIF9hcmVBbGxEYXRlc0F2YWlsYWJsZShmbGF0LCBkYXRlUmFuZ2UpIHtcbiAgICAgICAgcmV0dXJuIGRhdGVSYW5nZS5ldmVyeSgoZGF0ZSkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuICFmbGF0LmJvb2tlZERhdGVzLmluY2x1ZGVzKGRhdGUuZ2V0VGltZSgpKVxuICAgICAgICB9KVxuICAgIH1cblxuICAgIF9mb3JtYXRGbGF0T2JqZWN0KGZsYXQsIG5pZ2h0TnVtYmVyKSB7XG4gICAgICAgIGNvbnN0IGZvcm1hdHRlZEZsYXQgPSBPYmplY3QuYXNzaWduKHt9LCBmbGF0KVxuXG4gICAgICAgIGZvcm1hdHRlZEZsYXQucGhvdG9zID0gZm9ybWF0dGVkRmxhdC5waG90b3MubWFwKChwaG90b1VybCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIGBodHRwOi8vbG9jYWxob3N0OiR7YmFja2VuZFBvcnR9L2ltZy8ke3Bob3RvVXJsfWBcbiAgICAgICAgfSlcblxuICAgICAgICBpZiAobmlnaHROdW1iZXIgIT0gbnVsbCkge1xuICAgICAgICAgICAgZm9ybWF0dGVkRmxhdC50b3RhbFByaWNlID0gbmlnaHROdW1iZXIgKiBmb3JtYXR0ZWRGbGF0LnByaWNlXG4gICAgICAgICAgICBkZWxldGUgZm9ybWF0dGVkRmxhdC5wcmljZVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGZvcm1hdHRlZEZsYXRcbiAgICB9XG5cbiAgICBfcmVhZERhdGFiYXNlKCkge1xuICAgICAgICBjb25zdCBkYXRhID0gd2luZG93LmxvY2FsU3RvcmFnZS5nZXRJdGVtKGxvY2FsU3RvcmFnZUtleSlcblxuICAgICAgICBpZiAoZGF0YSA9PSBudWxsKSB7XG4gICAgICAgICAgICByZXR1cm4gZGF0YVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIEpTT04ucGFyc2UoZGF0YSlcbiAgICB9XG5cbiAgICBfd3JpdGVEYXRhYmFzZShkYXRhYmFzZSkge1xuICAgICAgICB3aW5kb3cubG9jYWxTdG9yYWdlLnNldEl0ZW0obG9jYWxTdG9yYWdlS2V5LCBKU09OLnN0cmluZ2lmeShkYXRhYmFzZSkpXG4gICAgfVxuXG4gICAgX3N5bmNEYXRhYmFzZShkYXRhYmFzZSkge1xuICAgICAgICB0aGlzLl93cml0ZURhdGFiYXNlKGRhdGFiYXNlKVxuICAgICAgICB0aGlzLmRhdGFiYXNlID0gdGhpcy5fcmVhZERhdGFiYXNlKClcbiAgICB9XG59XG4iXX0=